<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Como Conferir Prontuários — Sistema</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* Reset & base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{
            --bg: #e9f5ec;
            --text: #222;
            --verde-escuro: #0b6e4f;
            --verde-medio: #10a56f;
            --card-bg: #fff;
            --nav-bg: #fff;
            --header-gradient-start: #0b6e4f;
            --header-gradient-end: #10a56f;
        }
        html,body { height:100%; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background .25s, color .25s;
        }

        /* Dark theme overrides */
        body.dark {
            --bg: #111214;
            --text: #e8e8e8;
            --card-bg: #1f1f1f;
            --nav-bg: #181818;
            --header-gradient-start: #044b33;
            --header-gradient-end: #0b8f5a;
        }

        header {
            background: linear-gradient(135deg, var(--header-gradient-start), var(--header-gradient-end));
            padding: 80px 20px 50px;
            color: white;
            text-align: center;
            position: relative;
        }

        .logo-container {
            position: absolute;
            top: 16px;
            left: 16px;
            cursor: pointer;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .logo-container img {
            height: 70px;
            border-radius: 8px;
            background: white;
            padding: 5px;
        }
        .logo-label {
            color: white;
            font-weight: 700;
            letter-spacing: .3px;
        }

        /* nav: sticky and visible while scrolling, but lower z-index than overlays/panels */
        nav {
            background: var(--nav-bg);
            padding: 12px 18px;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            z-index: 60; /* lower than overlays/panels */
            transition: opacity .18s, transform .18s;
        }
        nav.hidden { display: none !important; } /* used when panels/overlay open */
        nav ul {
            display:flex;
            justify-content:center;
            gap:18px;
            list-style:none;
            flex-wrap:wrap;
            align-items:center;
        }
        nav a {
            text-decoration:none;
            font-weight:600;
            color: var(--verde-escuro);
            transition: .15s;
            cursor: pointer;
        }
        nav a:hover { color: var(--verde-medio); }

        .container {
            max-width: 1000px;
            margin: 36px auto;
            padding: 20px;
        }
        section {
            background: var(--card-bg);
            padding: 22px;
            margin-bottom: 26px;
            border-radius: 12px;
            border-left: 6px solid var(--verde-medio);
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: transform .2s, box-shadow .2s, background .2s, color .2s;
        }
        section:hover { transform: translateY(-4px); box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
        .cards { display:grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
        .card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 10px;
            border-left: 5px solid var(--verde-escuro);
            box-shadow: 0 4px 14px rgba(0,0,0,0.06);
        }

        h1 { font-size:1.8rem; margin-bottom:8px; }
        h2 { color: var(--verde-escuro); margin-bottom:12px; }
        h3 { margin-bottom:8px; color: var(--verde-escuro); }

        footer {
            background: var(--verde-escuro);
            color: white;
            text-align:center;
            padding:22px 12px;
            margin-top:40px;
        }

        .pdf-btn {
            display:inline-block;
            background: #0b8f5a;
            color: white;
            padding:12px 18px;
            border-radius:8px;
            text-decoration:none;
            font-weight:600;
        }

        /* ---------- LOGIN OVERLAY ---------- */
        #loginOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index: 9999; /* higher than nav */
        }
        .login-box {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            width: 360px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            color: var(--text);
            transition: background .2s, color .2s;
        }
        .login-box h2 { text-align:center; margin-bottom:14px; color:var(--verde-escuro); }
        .login-box label { font-weight:600; display:block; margin-top:10px; margin-bottom:6px; }
        .login-box input[type="text"],
        .login-box input[type="password"],
        .login-box input[type="email"] {
            width:100%;
            padding:10px 12px;
            border-radius:8px;
            border:1px solid #ddd;
            background: #fff;
            color: #222;
        }
        .login-box .password-wrapper { position:relative; }
        .login-box .password-wrapper i {
            position:absolute;
            right:12px;
            top:50%;
            transform:translateY(-50%);
            cursor:pointer;
            color: #666;
        }
        .login-box button {
            width:100%;
            padding:10px 12px;
            margin-top:16px;
            border-radius:8px;
            border:none;
            background:var(--verde-medio);
            color:white;
            font-weight:700;
            cursor:pointer;
        }

        @keyframes shake {
            0% { transform: translateX(0) }
            20% { transform: translateX(-6px) }
            40% { transform: translateX(6px) }
            60% { transform: translateX(-6px) }
            80% { transform: translateX(6px) }
            100% { transform: translateX(0) }
        }

        /* ---------- ADMIN PANEL (UPDATED) ---------- */
        #adminPanel {
            display:none;
            position: fixed;
            top: 86px;
            left: 20px;
            background: var(--card-bg);
            color: var(--text);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            z-index: 10002; /* above nav and overlay */
            width: 720px;
            max-width: calc(100% - 40px);
            transition: background .2s, color .2s;
        }
        #adminPanel h3 { margin-bottom:8px; color:var(--verde-escuro); }
        .admin-tabs { display:flex; gap:8px; margin-bottom:10px; }
        .admin-tabs button { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; background:#eee; font-weight:700; }
        .admin-tabs button.active { background: var(--verde-escuro); color:white; }

        /* users list */
        #listaUsuarios { list-style:none; padding:0; margin:0; max-height:260px; overflow:auto; }
        #listaUsuarios li { padding:10px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; gap:12px; align-items:center; }
        .user-actions { display:flex; gap:8px; }

        /* logs */
        #logsTable { width:100%; border-collapse: collapse; margin-top:8px; max-height:300px; overflow:auto; display:block; }
        #logsTable thead { background:#f7f7f7; position:sticky; top:0; }
        #logsTable th, #logsTable td { padding:8px 10px; border-bottom:1px solid #eee; text-align:left; white-space:nowrap; }
        #logsWrapper { max-height:340px; overflow:auto; margin-top:6px; }

        .controls-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }

        /* user topbar */
        .user-bar {
            position: fixed;
            right: 16px;
            top: 86px;
            background: var(--card-bg);
            color: var(--text);
            padding:8px 12px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            z-index: 10003; /* above nav */
            display:flex;
            gap:10px;
            align-items:center;
        }
        .user-bar .name { font-weight:700; }
        .user-bar button { padding:6px 10px; border-radius:8px; border:none; cursor:pointer; background:var(--verde-medio); color:white; font-weight:700; }

        /* Perfil modal sits above admin/panels */
        #perfilModal {
            display:none;
            position:fixed;
            inset:0;
            z-index:10004;
            align-items:center;
            justify-content:center;
            background: rgba(0,0,0,0.5);
        }
        #perfilModal .box {
            background:var(--card-bg);
            color:var(--text);
            padding:18px;
            border-radius:10px;
            width:360px;
            box-shadow:0 10px 30px rgba(0,0,0,0.25);
        }

        /* small screens */
        @media (max-width:900px){
            #adminPanel { width: calc(100% - 32px); left: 16px; right:16px; top:100px; }
        }
        @media (max-width:640px){
            .login-box{ width:90%; }
            .user-bar { right:8px; top:100px; }
            nav ul { gap:10px; font-size:0.95rem; }
        }

    </style>
</head>
<body>
    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" aria-hidden="false">
        <div class="login-box" id="loginBox" role="dialog" aria-labelledby="loginTitle">
            <h2 id="loginTitle">Acessar sistema</h2>

            <label for="userLogin">Usuário</label>
            <input id="userLogin" type="text" autocomplete="username" placeholder="Digite seu usuário">

            <label for="userSenha">Senha</label>
            <div class="password-wrapper">
                <input id="userSenha" type="password" autocomplete="current-password" placeholder="Digite sua senha">
                <i class="fa-solid fa-eye" id="toggleSenha" title="Mostrar/ocultar senha" aria-hidden="true"></i>
            </div>

            <button id="btnEntrar" onclick="login()">Entrar</button>

            <p style="text-align:center; margin-top:10px; font-size:0.9rem; color:#666;">
                Usuários exemplo: <strong>admin / 1234</strong> (admin) • <strong>yuri / 1234</strong> (viewer)
            </p>
        </div>
    </div>

    <!-- ADMIN PANEL (aberto clicando na logo ou via botão admin) -->
    <div id="adminPanel" aria-hidden="true">
        <h3>Painel Administrativo</h3>

        <div class="admin-tabs">
            <button id="tabUsers" class="active" onclick="showAdminTab('users')">Usuários</button>
            <button id="tabLogs" onclick="showAdminTab('logs')">Logs</button>
        </div>

        <div id="adminUsers" class="admin-section">
            <div>
                <strong>Usuários registrados</strong>
                <ul id="listaUsuarios"></ul>
            </div>

            <div style="margin-top:10px;">
                <strong>Criar usuário</strong>
                <div class="create-row" style="display:flex; gap:8px; margin-top:8px;">
                    <input id="newUserName" placeholder="usuário" />
                    <select id="newUserRole">
                        <option value="viewer">viewer</option>
                        <option value="admin">admin</option>
                    </select>
                    <input id="newUserSenha" placeholder="senha" style="width:120px;" />
                    <button class="btn" onclick="criarUsuario()">Criar</button>
                </div>

                <div style="margin-top:10px; display:flex; gap:8px; justify-content:space-between; flex-wrap:wrap;">
                    <div style="display:flex; gap:8px;">
                        <button class="btn muted" onclick="exportarUsuarios()">Exportar (JSON)</button>
                        <button class="btn danger" onclick="resetarUsuarios()">Resetar padrões</button>
                    </div>
                    <div>
                        <button class="btn" onclick="fecharAdmin()">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="adminLogs" class="admin-section" style="display:none; margin-top:8px;">
            <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label>Usuário:
                        <select id="filterUser">
                            <option value="">Todos</option>
                        </select>
                    </label>
                    <label>Data início: <input type="date" id="filterDateFrom"></label>
                    <label>Data fim: <input type="date" id="filterDateTo"></label>
                    <label>Ação:
                        <select id="filterAction">
                            <option value="">Todas</option>
                        </select>
                    </label>
                    <button class="btn" onclick="aplicarFiltrosLogs()">Aplicar</button>
                    <button class="btn muted" onclick="limparFiltrosLogs()">Limpar</button>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" onclick="exportarLogs()">Exportar logs (JSON)</button>
                    <button class="btn danger" onclick="limparLogsConfirm()">Limpar logs</button>
                </div>
            </div>

            <div id="logsWrapper">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>Data / Hora</th>
                            <th>Usuário</th>
                            <th>Ação</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- user bar (aparece quando logado) -->
    <div id="userBar" class="user-bar" style="display:none;">
        <span class="name" id="userNome">Usuário</span>
        <button onclick="abrirPerfil()">Meu Perfil</button>
        <button id="btnOpenAdmin" onclick="handleNavAdmin()" title="Admin" style="display:none;">Admin</button>
        <button onclick="logout()" title="Sair">Sair</button>
    </div>

    <!-- SITE -->
    <header>
        <div class="logo-container" title="Abrir painel admin">
            <img src="https://leannasemergencias.com.br/wp-content/uploads/group-avatars/62/5c74020bb481d-bpfull.jpg" alt="Logo SAME" id="logoSite">
            <span class="logo-label">Guia - Conferência de Prontuários</span>
        </div>

        <h1>Guia Completo para Conferência de Prontuários</h1>
        <p>Organização, segurança e qualidade nas informações administrativas.</p>
    </header>

    <nav id="mainNav">
        <ul>
            <li><a href="#download">PDF</a></li>
            <li><a href="#importancia">Importância</a></li>
            <li><a href="#materiais">Materiais</a></li>
            <li><a href="#o-que-e">Prontuário</a></li>
            <li><a href="#preparo">Preparo</a></li>
            <li><a href="#passos">Passos</a></li>
            <li><a href="#erros">Erros</a></li>
            <li><a href="#boas-praticas">Boas práticas</a></li>
            <li><a href="#fluxo">Fluxo</a></li>
            <li><a href="#faq">FAQ</a></li>

            <!-- NOTE: Admin link removed from public nav -->
            <li><a id="navPerfil" onclick="handleNavPerfil()">Perfil</a></li>
        </ul>
    </nav>

    <main class="container" id="siteContent">
        <!-- (conteúdo original do site — secções) -->
        <section id="download">
            <h2><i class="fa-solid fa-file-pdf"></i> Baixar PDF</h2>
            <p>Clique no botão abaixo para baixar o checklist em PDF.</p>
            <a id="downloadPdf" class="pdf-btn" href="https://seu-link-do-pdf-aqui.com/checklist.pdf" download>
                <i class="fa-solid fa-download"></i> Baixar PDF
            </a>
        </section>

        <section id="importancia">
            <h2><i class="fa-solid fa-star"></i> Importância da conferência</h2>
            <ul>
                <li>Padronização e legibilidade das informações.</li>
                <li>Correção de dados administrativos.</li>
                <li>Organização para auditorias internas e externas.</li>
                <li>Respeito às normas legais e institucionais.</li>
                <li>Segurança e integridade das informações.</li>
            </ul>
        </section>

        <section id="materiais">
            <h2><i class="fa-solid fa-folder-open"></i> Materiais necessários</h2>
            <ul>
                <li>Checklist de conferência oficial.</li>
                <li>Acesso autorizado ao prontuário.</li>
                <li>Ferramenta de anotação.</li>
                <li>Ambiente silencioso e seguro.</li>
                <li>Caneta.</li>
                <li>Tira grampos.</li>
                <li>Carimbos.</li>
            </ul>
        </section>

        <section id="o-que-e">
            <h2><i class="fa-solid fa-notes-medical"></i> O que é um prontuário?</h2>
            <p>O prontuário reúne informações registradas durante o atendimento e deve manter organização, legibilidade e conformidade institucional.</p>
        </section>

        <section id="preparo">
            <h2><i class="fa-solid fa-clipboard-check"></i> Antes de começar</h2>
            <div class="cards">
                <div class="card">
                    <i class="fa-solid fa-id-card"></i>
                    <h3>Autorização</h3>
                    <p>Confirme se possui permissão formal.</p>
                </div>

                <div class="card">
                    <i class="fa-solid fa-shield-halved"></i>
                    <h3>Sigilo</h3>
                    <p>Proteja dados sensíveis conforme a LGPD.</p>
                </div>

                <div class="card">
                    <i class="fa-solid fa-list-check"></i>
                    <h3>Checklist</h3>
                    <p>Use o checklist oficial da instituição.</p>
                </div>
            </div>
        </section>

        <section id="passos">
            <h2><i class="fa-solid fa-list-ul"></i> Passo a passo</h2>
            <ul>
                <li>Verifique a identificação do paciente.</li>
                <li>Organize páginas e documentos.</li>
                <li>Confirme datas e assinaturas.</li>
                <li>Cheque campos obrigatórios.</li>
                <li>Valide anexos.</li>
            </ul>
        </section>

        <section id="erros">
            <h2><i class="fa-solid fa-exclamation-triangle"></i> Erros comuns</h2>
            <ul>
                <li>Assinaturas faltando.</li>
                <li>Páginas desorganizadas.</li>
                <li>Campos incompletos.</li>
                <li>Folhas ausentes.</li>
            </ul>
        </section>

        <section id="boas-praticas">
            <h2><i class="fa-solid fa-thumbs-up"></i> Boas práticas</h2>
            <ul>
                <li>Trabalhe em ambiente silencioso.</li>
                <li>Checar itens críticos duas vezes.</li>
                <li>Registrar inconsistências na hora.</li>
            </ul>
        </section>

        <section id="fluxo">
            <h2><i class="fa-solid fa-diagram-project"></i> Fluxo recomendado</h2>
            <ol>
                <li>Receber o prontuário.</li>
                <li>Verificar autorização.</li>
                <li>Organizar documentos.</li>
                <li>Aplicar checklist.</li>
                <li>Registrar irregularidades.</li>
                <li>Encaminhar correções.</li>
                <li>Arquivar corretamente.</li>
            </ol>
        </section>

        <section id="faq">
            <h2><i class="fa-solid fa-circle-question"></i> FAQ</h2>

            <h3>Posso corrigir um prontuário?</h3>
            <p>Somente o profissional responsável pode corrigir.</p>

            <h3>Posso fotografar o prontuário?</h3>
            <p>Em geral, não. Informações são sigilosas.</p>

            <h3>Preciso de autorização?</h3>
            <p>Sempre. O acesso deve ser justificado e formal.</p>
        </section>
    </main>

    <footer>
        <p>Guia Educativo — Hospital Vila Nova • 2025</p>
        <p style="font-size:1.05rem; font-weight:700; margin-top:8px;">Registrado por: Yuri Santos Coutinho</p>
        <p style="font-size:1.05rem; font-weight:700; margin-top:6px;">EMAIL: coutinhoyuri17@gmail.com</p>
    </footer>

    <!-- Perfil modal (para trocar senha e tema) -->
    <div id="perfilModal">
        <div class="box">
            <h3 style="color:var(--verde-escuro); margin-bottom:8px;">Meu Perfil</h3>

            <div style="margin-top:6px;">
                <strong>Usuário:</strong> <span id="perfilNome"></span>
            </div>

            <div style="margin-top:10px;">
                <label style="display:block; margin-bottom:6px; font-weight:600;">Trocar senha</label>
                <input id="perfilSenhaNova" type="password" placeholder="Nova senha" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button onclick="trocarSenha()" style="flex:1; padding:8px; border-radius:6px; border:none; background:var(--verde-medio); color:white; font-weight:700;">Alterar</button>
                    <button onclick="fecharPerfil()" style="flex:1; padding:8px; border-radius:6px; border:none; background:#ddd;">Fechar</button>
                </div>
            </div>

            <div style="margin-top:12px;">
                <label style="display:block; margin-bottom:6px; font-weight:600;">Tema</label>
                <select id="perfilTema" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                    <option value="light">Claro</option>
                    <option value="dark">Escuro</option>
                </select>
            </div>

            <!-- Auto-login preference -->
            <div style="margin-top:12px;">
                <label style="display:block; margin-bottom:6px; font-weight:600;">Preferência de Login</label>
                <label style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
                    <input type="radio" name="perfilAutoLogin" value="always" id="perfilAutoAlways"> Sempre pedir senha
                </label>
                <label style="display:flex; gap:8px; align-items:center;">
                    <input type="radio" name="perfilAutoLogin" value="auto" id="perfilAutoAuto"> Entrar automaticamente neste dispositivo
                </label>
            </div>

            <div style="margin-top:12px; display:flex; gap:8px;">
                <button onclick="salvarPerfil()" style="flex:1; padding:8px; border-radius:6px; border:none; background:#0b6e4f; color:white; font-weight:700;">Salvar Perfil</button>
                <button onclick="fecharPerfil()" style="flex:1; padding:8px; border-radius:6px; border:none; background:#ddd;">Fechar</button>
            </div>
        </div>
    </div>

    <script>
    /*******************
     * Gerenciamento de usuários e logs (front-end apenas)
     * salva em localStorage
     *******************/
    const STORAGE_KEY = "sistema_usuarios_v1";
    const STORAGE_USER = "sistema_logado_v1";
    const STORAGE_LOGS = "sistema_logs_v1";

    // Carrega usuários do localStorage ou cria padrões
    function carregarUsuarios(){
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){
            const padrao = [
                { user: "admin", senha: "1234", role: "admin", tema: "light", autoLogin: false },
                { user: "yuri", senha: "1234", role: "viewer", tema: "light", autoLogin: false },
            ];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(padrao));
            return padrao;
        }
        try {
            const arr = JSON.parse(raw);
            return arr.map(u => ({
                user: u.user,
                senha: u.senha,
                role: u.role || "viewer",
                tema: u.tema || "light",
                autoLogin: typeof u.autoLogin === "boolean" ? u.autoLogin : false
            }));
        } catch(e){ return []; }
    }

    // Logs helpers
    function carregarLogs(){ 
        try { return JSON.parse(localStorage.getItem(STORAGE_LOGS) || "[]"); }
        catch(e){ return []; }
    }
    function salvarLogs(arr){ localStorage.setItem(STORAGE_LOGS, JSON.stringify(arr)); }
    function logEvent(action, details = ""){
        const now = new Date();
        const entry = {
            ts: now.toISOString(),
            datetime: now.toLocaleString(),
            user: usuarioLogado ? usuarioLogado.user : "ANÔNIMO",
            action,
            details
        };
        const logs = carregarLogs();
        logs.unshift(entry); // newest first
        salvarLogs(logs);
    }

    let usuarios = carregarUsuarios();
    let usuarioLogado = null;

    /* helper: esconder/mostrar nav (usado quando abrir panels/overlay) */
    function esconderNav(){ document.getElementById("mainNav").classList.add("hidden"); }
    function mostrarNav(){ document.getElementById("mainNav").classList.remove("hidden"); }

    // Aplica tema (global) — e também lê tema do usuário quando logado
    function aplicarTema(tema){
        if(tema === "dark") document.body.classList.add("dark");
        else document.body.classList.remove("dark");
    }

    // Atualiza UI do botão admin no userBar (visível só para admin)
    function atualizarUserBarAdminButton(){
        const btn = document.getElementById("btnOpenAdmin");
        if(usuarioLogado && usuarioLogado.role === "admin") btn.style.display = "inline-block";
        else btn.style.display = "none";
    }

    // Quando a página carrega, checar sessão e auto-login
    document.addEventListener("DOMContentLoaded", () => {
        // toggler olho - login
        const toggle = document.getElementById("toggleSenha");
        if(toggle){
            toggle.addEventListener("click", () => {
                const el = document.getElementById("userSenha");
                if(el.type === "password"){ el.type = "text"; toggle.classList.remove("fa-eye"); toggle.classList.add("fa-eye-slash"); }
                else { el.type = "password"; toggle.classList.add("fa-eye"); toggle.classList.remove("fa-eye-slash"); }
            });
        }

        // click on logo tries to open admin (only admin allowed)
        document.querySelector(".logo-container").addEventListener("click", () => {
            if(!usuarioLogado){ alert("Você precisa estar logado como administrador."); return; }
            if(usuarioLogado.role !== "admin"){ alert("Apenas administradores podem acessar o painel."); return; }
            abrirAdmin();
        });

        // download log (track when clicked)
        document.getElementById("downloadPdf").addEventListener("click", (e) => {
            // log the action and allow native download
            setTimeout(() => { logEvent("download_pdf", "Baixou PDF de checklist"); }, 50);
        });

        // if existe sessão (login por sessão)
        const sessao = localStorage.getItem(STORAGE_USER);
        if(sessao){
            try{
                const obj = JSON.parse(sessao);
                usuarios = carregarUsuarios(); // recarregar para garantir atualizações
                const encontrado = usuarios.find(u => u.user === obj.user);
                if(encontrado && encontrado.senha === obj.senha){
                    usuarioLogado = encontrado;
                    onLogin(false); // false = não registrar novo log de login porque session existe
                    return;
                }
            }catch(e){}
        }

        // verificar auto-login por preferência do usuário (ultimoUsuario)
        const ultimo = localStorage.getItem("ultimoUsuario");
        if(ultimo){
            usuarios = carregarUsuarios();
            const u = usuarios.find(x => x.user === ultimo);
            if(u && u.autoLogin){
                usuarioLogado = u;
                onLogin(true);
                return;
            }
        }

        // Sem sessão/autologin: mostrar overlay e aplicar tema default (light)
        aplicarTema("light");
        document.getElementById("loginOverlay").style.display = "flex";
        esconderNav(); // hide nav while login overlay is present
    });

    // Função de login
    function login(){
        const u = document.getElementById("userLogin").value.trim();
        const s = document.getElementById("userSenha").value;

        usuarios = carregarUsuarios();
        const encontrado = usuarios.find(x => x.user === u && x.senha === s);
        if(!encontrado){
            // animar shake
            const box = document.getElementById("loginBox");
            box.style.animation = "shake .4s";
            setTimeout(()=> box.style.animation = "", 420);
            return;
        }

        usuarioLogado = encontrado;
        // salvar sessão (simples)
        localStorage.setItem(STORAGE_USER, JSON.stringify({ user: encontrado.user, senha: encontrado.senha }));
        // registrar ultimo usuário (para preferência)
        localStorage.setItem("ultimoUsuario", encontrado.user);
        onLogin(true);
    }

    // Ao logar: esconder overlay, mostrar userbar e aplicar tema do usuário
    // param shouldLog indica se registramos o evento de login (true normalmente)
    function onLogin(shouldLog = true){
        document.getElementById("loginOverlay").style.display = "none";
        mostrarNav();
        document.getElementById("userBar").style.display = "flex";
        document.getElementById("userNome").textContent = usuarioLogado.user;

        // aplicar tema salvo no usuário
        aplicarTema(usuarioLogado.tema || "light");

        // atualizar lista do admin (caso abra)
        atualizarListaUsuarios();
        atualizarUserBarAdminButton();

        if(shouldLog) logEvent("login", `Usuário ${usuarioLogado.user} realizou login`);
    }

    // Logout
    function logout(){
        if(usuarioLogado) logEvent("logout", `Usuário ${usuarioLogado.user} efetuou logout`);
        usuarioLogado = null;
        localStorage.removeItem(STORAGE_USER);
        document.getElementById("userBar").style.display = "none";
        document.getElementById("loginOverlay").style.display = "flex";
        // limpar campos
        document.getElementById("userLogin").value = "";
        document.getElementById("userSenha").value = "";
        // resetar tema default
        aplicarTema("light");
        esconderNav(); // hide nav during login

        // fechar possíveis painéis/modals abertos para evitar "restos" de outra sessão
        fecharPerfil(false);
        fecharAdmin(false);
    }

    // abrir painel admin (clicando na logo ou nav) — apenas admin
    // Nav handlers for Perfil and Admin
    function handleNavAdmin(){
        if(!usuarioLogado){ alert("Faça login primeiro."); return; }
        if(usuarioLogado.role !== "admin"){ alert("Apenas administradores podem acessar o painel."); return; }
        abrirAdmin();
    }
    function handleNavPerfil(){
        if(!usuarioLogado){ alert("Faça login primeiro."); return; }
        abrirPerfil();
    }

    function abrirAdmin(){
        esconderNav();
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("adminPanel").setAttribute("aria-hidden","false");
        atualizarListaUsuarios();
        preencherFilterUsers();
        preencherFilterActions();
        preencherLogs();
        logEvent("abrir_admin", "Abriu painel administrativo");
    }
    // fecharAdmin optionally log (pass true/false)
    function fecharAdmin(shouldLog = true){
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("adminPanel").setAttribute("aria-hidden","true");
        mostrarNav();
        if(shouldLog && usuarioLogado) logEvent("fechar_admin", "Fechou painel administrativo");
    }

    // Admin tabs
    function showAdminTab(tab){
        document.getElementById("tabUsers").classList.remove("active");
        document.getElementById("tabLogs").classList.remove("active");
        document.getElementById("adminUsers").style.display = "none";
        document.getElementById("adminLogs").style.display = "none";
        if(tab === "users"){
            document.getElementById("tabUsers").classList.add("active");
            document.getElementById("adminUsers").style.display = "block";
        } else {
            document.getElementById("tabLogs").classList.add("active");
            document.getElementById("adminLogs").style.display = "block";
            // refresh logs view
            preencherFilterUsers();
            preencherFilterActions();
            preencherLogs();
        }
    }

    // Atualizar lista no admin
    function atualizarListaUsuarios(){
        usuarios = carregarUsuarios();
        const lista = document.getElementById("listaUsuarios");
        lista.innerHTML = "";

        usuarios.forEach(u => {
            const li = document.createElement("li");
            const left = document.createElement("div");
            left.style.display = "flex";
            left.style.flexDirection = "column";
            left.innerHTML = `<span style="font-weight:700">${u.user}</span><small style="color:#666">${u.role}</small>`;

            const right = document.createElement("div");
            right.className = "user-actions";
            // botões (admin pode reset/senha e deletar)
            const btnReset = document.createElement("button");
            btnReset.className = "btn muted";
            btnReset.textContent = "Reset Senha";
            btnReset.onclick = () => {
                const nova = prompt("Nova senha para " + u.user + ":", "1234");
                if(nova !== null && nova.trim() !== ""){
                    // update in array
                    usuarios = carregarUsuarios().map(item => {
                        if(item.user === u.user) item.senha = nova;
                        return item;
                    });
                    salvarUsuarios();
                    atualizarListaUsuarios();
                    logEvent("reset_senha_admin", `Admin resetou senha de ${u.user}`);
                    alert("Senha alterada.");
                }
            };
            const btnExcluir = document.createElement("button");
            btnExcluir.className = "btn danger";
            btnExcluir.textContent = "Excluir";
            btnExcluir.onclick = () => {
                if(u.user === usuarioLogado.user){ alert("Você não pode excluir o próprio usuário."); return; }
                if(confirm("Excluir usuário " + u.user + " ?")){
                    usuarios = carregarUsuarios().filter(x => x.user !== u.user);
                    salvarUsuarios();
                    atualizarListaUsuarios();
                    logEvent("excluir_usuario", `Usuário ${u.user} excluído pelo admin ${usuarioLogado.user}`);
                }
            };

            // se for admin logado, mostrar controles; senão apenas mostrar role
            if(usuarioLogado && usuarioLogado.role === "admin"){
                right.appendChild(btnReset);
                right.appendChild(btnExcluir);
            }

            li.appendChild(left);
            li.appendChild(right);
            lista.appendChild(li);
        });
    }

    // Criar usuário (admin)
    function criarUsuario(){
        if(!usuarioLogado || usuarioLogado.role !== "admin"){ alert("Apenas admin pode criar usuários."); return; }
        const nome = document.getElementById("newUserName").value.trim();
        const senha = document.getElementById("newUserSenha").value || "1234";
        const role = document.getElementById("newUserRole").value;

        usuarios = carregarUsuarios();

        if(!nome){ alert("Informe um nome de usuário."); return; }
        if(usuarios.find(u => u.user === nome)){ alert("Usuário já existe."); return; }

        usuarios.push({ user: nome, senha: senha, role: role, tema: "light", autoLogin: false });
        salvarUsuarios();
        document.getElementById("newUserName").value = "";
        document.getElementById("newUserSenha").value = "";
        atualizarListaUsuarios();
        logEvent("criar_usuario", `Usuário ${nome} criado pelo admin ${usuarioLogado.user}`);
    }

    // salvar usuarios no storage
    function salvarUsuarios(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(usuarios));
    }

    // Exportar usuarios (JSON)
    function exportarUsuarios(){
        const data = JSON.stringify(carregarUsuarios(), null, 2);
        // abrir em nova aba como blob
        const blob = new Blob([data], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "usuarios.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        logEvent("exportar_usuarios", "Exportou lista de usuários (JSON)");
    }

    // Resetar para usuários padrões
    function resetarUsuarios(){
        if(!confirm("Resetar usuários para o padrão? Isto restaurará admin/yuri.")) return;
        localStorage.removeItem(STORAGE_KEY);
        usuarios = carregarUsuarios();
        salvarUsuarios();
        atualizarListaUsuarios();
        logEvent("resetar_usuarios", "Resetou usuários para padrão");
        alert("Reset concluído.");
    }

    // abrir perfil: viewer pode trocar só a própria senha e escolher tema
    function abrirPerfil(){
        if(!usuarioLogado) return alert("Logue primeiro.");
        document.getElementById("perfilNome").textContent = usuarioLogado.user;
        document.getElementById("perfilTema").value = usuarioLogado.tema || "light";

        // setar opção de auto-login no modal
        if(usuarioLogado.autoLogin){
            document.getElementById("perfilAutoAuto").checked = true;
        } else {
            document.getElementById("perfilAutoAlways").checked = true;
        }

        esconderNav();
        document.getElementById("perfilModal").style.display = "flex";
        logEvent("abrir_perfil", `Abriu perfil (${usuarioLogado.user})`);
    }

    function fecharPerfil(shouldLog = true){
        document.getElementById("perfilModal").style.display = "none";
        mostrarNav();
        if(shouldLog && usuarioLogado) logEvent("fechar_perfil", `Fechou perfil (${usuarioLogado.user})`);
    }

    // trocar senha do usuário logado
    function trocarSenha(){
        if(!usuarioLogado) return alert("Logue primeiro.");
        const nova = document.getElementById("perfilSenhaNova").value.trim();
        if(!nova){ alert("Informe a nova senha."); return; }

        // atualizar no array e storage
        usuarios = carregarUsuarios().map(u => {
            if(u.user === usuarioLogado.user){
                u.senha = nova;
            }
            return u;
        });
        salvarUsuarios();

        // atualizar sessão em storage
        usuarioLogado.senha = nova;
        localStorage.setItem(STORAGE_USER, JSON.stringify({ user: usuarioLogado.user, senha: usuarioLogado.senha }));

        document.getElementById("perfilSenhaNova").value = "";
        logEvent("trocar_senha", `Usuário ${usuarioLogado.user} alterou sua senha`);
        alert("Senha alterada com sucesso.");
    }

    // salvar tema e preferência de auto-login no perfil (aplica a todo site)
    function salvarPerfil(){
        if(!usuarioLogado) return alert("Logue primeiro.");
        const tema = document.getElementById("perfilTema").value;
        const pref = document.querySelector('input[name="perfilAutoLogin"]:checked')?.value || "always";

        // salvar no usuário
        usuarios = carregarUsuarios().map(u => {
            if(u.user === usuarioLogado.user){
                u.tema = tema;
                u.autoLogin = (pref === "auto");
            }
            return u;
        });
        salvarUsuarios();

        // atualizar objeto atual
        usuarioLogado.tema = tema;
        usuarioLogado.autoLogin = (pref === "auto");

        // se ativou autoLogin, registrar como ultimoUsuario para permitir login autom. futuro
        if(usuarioLogado.autoLogin){
            localStorage.setItem("ultimoUsuario", usuarioLogado.user);
        } else {
            // se desativou autoLogin e for o mesmo user salvo, remover o ultimoUsuario
            const ultimo = localStorage.getItem("ultimoUsuario");
            if(ultimo === usuarioLogado.user) localStorage.removeItem("ultimoUsuario");
        }

        aplicarTema(tema);
        logEvent("salvar_perfil", `Usuário ${usuarioLogado.user} salvou preferências (tema:${tema}, autoLogin:${usuarioLogado.autoLogin})`);
        alert("Preferências salvas.");
        fecharPerfil();
    }

    /***** LOGS: preencher e filtros *****/
    function preencherFilterUsers(){
        const sel = document.getElementById("filterUser");
        if(!sel) return;
        const users = [...new Set(carregarLogs().map(l => l.user).filter(u=>u))].sort();
        sel.innerHTML = '<option value="">Todos</option>';
        users.forEach(u => {
            const opt = document.createElement("option");
            opt.value = u;
            opt.textContent = u;
            sel.appendChild(opt);
        });
    }
    function preencherFilterActions(){
        const sel = document.getElementById("filterAction");
        if(!sel) return;
        const actions = [...new Set(carregarLogs().map(l => l.action))].sort();
        sel.innerHTML = '<option value="">Todas</option>';
        actions.forEach(a => {
            const opt = document.createElement("option");
            opt.value = a;
            opt.textContent = a;
            sel.appendChild(opt);
        });
    }

    function aplicarFiltrosLogs(){
        preencherLogs();
    }
    function limparFiltrosLogs(){
        document.getElementById("filterUser").value = "";
        document.getElementById("filterAction").value = "";
        document.getElementById("filterDateFrom").value = "";
        document.getElementById("filterDateTo").value = "";
        preencherLogs();
    }

    function preencherLogs(){
        const logs = carregarLogs();
        const tbody = document.getElementById("logsBody");
        if(!tbody) return;
        const userF = document.getElementById("filterUser")?.value || "";
        const actionF = document.getElementById("filterAction")?.value || "";
        const dateFrom = document.getElementById("filterDateFrom")?.value;
        const dateTo = document.getElementById("filterDateTo")?.value;

        const filtered = logs.filter(l => {
            if(userF && l.user !== userF) return false;
            if(actionF && l.action !== actionF) return false;
            if(dateFrom){
                if(new Date(l.ts) < new Date(dateFrom + "T00:00:00")) return false;
            }
            if(dateTo){
                if(new Date(l.ts) > new Date(dateTo + "T23:59:59")) return false;
            }
            return true;
        });

        tbody.innerHTML = "";
        filtered.forEach(l => {
            const tr = document.createElement("tr");
            const td1 = document.createElement("td"); td1.textContent = l.datetime;
            const td2 = document.createElement("td"); td2.textContent = l.user;
            const td3 = document.createElement("td"); td3.textContent = l.action;
            const td4 = document.createElement("td"); td4.textContent = l.details;
            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);
            tbody.appendChild(tr);
        });
    }

    function exportarLogs(){
        const logs = carregarLogs();
        const data = JSON.stringify(logs, null, 2);
        const blob = new Blob([data], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "logs.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        logEvent("exportar_logs", "Exportou logs (JSON)");
    }

    function limparLogsConfirm(){
        if(!confirm("Limpar todos os logs? Essa ação não pode ser desfeita.")) return;
        salvarLogs([]);
        preencherLogs();
        logEvent("limpar_logs", `Logs limpos pelo admin ${usuarioLogado ? usuarioLogado.user : "?"}`);
        alert("Logs limpos.");
    }

    // Hook Enter key on login inputs
    document.getElementById("userSenha").addEventListener("keydown", (e) => {
        if(e.key === "Enter") login();
    });
    document.getElementById("userLogin").addEventListener("keydown", (e) => {
        if(e.key === "Enter") login();
    });

    // Ensure when page unload logs out? optional (not automatically logging out)
    window.addEventListener("beforeunload", () => {
        // no action to prevent losing session - keep it simple
    });

    </script>
</body>
</html>
